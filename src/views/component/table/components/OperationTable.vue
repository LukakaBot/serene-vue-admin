<script setup lang="ts">
import type { InternalRowData } from 'naive-ui/es/data-table/src/interface'
import type {
  AppTableColumn,
  Operations,
} from '@/components/base/AppTable/types'
import { NAvatar, NTag } from 'naive-ui'
import { fetchTableDataPage } from '@/api/table/index.ts'
import { useLoading } from '@/hooks'

const [loading, setLoading] = useLoading()

const searchParams = ref({
  page: 1,
  pageSize: 10,
  total: 0,
})

/* eslint-disable-next-line  ts/no-explicit-any */
const tableData = ref<any>([])

const columns: AppTableColumn[] = [
  {
    title: 'id',
    align: 'center',
    key: 'index',
    width: 60,
    fixed: 'left',
    render: (_, index) => `${index + 1}`,
  },
  {
    title: '编号',
    key: 'no',
    width: 120,
    align: 'center',
    ellipsis: { tooltip: true },
  },
  {
    title: '名称',
    key: 'name',
    width: 120,
    align: 'center',
    ellipsis: { tooltip: true },
  },
  {
    title: '头像',
    key: 'avatar',
    width: 120,
    align: 'center',
    ellipsis: { tooltip: true },
    render: renderAvatar,
  },
  {
    title: '地址',
    key: 'address',
    width: 180,
    align: 'center',
    ellipsis: { tooltip: true },
  },
  {
    title: '开始日期',
    key: 'beginTime',
    width: 180,
    align: 'center',
    ellipsis: { tooltip: true },
  },
  {
    title: '结束日期',
    key: 'endTime',
    width: 180,
    align: 'center',
    ellipsis: { tooltip: true },
  },
  {
    title: '状态',
    key: 'status',
    width: 120,
    align: 'center',
    ellipsis: { tooltip: true },
    render: renderStatusTag,
  },
  {
    title: '创建时间',
    key: 'date',
    width: 180,
    align: 'center',
    ellipsis: { tooltip: true },
  },
  {
    title: '停留时间',
    key: 'time',
    width: 80,
    align: 'center',
    ellipsis: { tooltip: true },
  },
]

const operations: Operations = [
  { type: 'primary', text: '详情', icon: 'mdi:document' },
  { type: 'primary', text: '修改', icon: 'mdi:pencil' },
  { type: 'error', text: '删除', icon: 'mdi:trash-can' },
]

function handleOperate(key: string, _row: InternalRowData) {
  switch (key) {
    case '详情':
      window.$message?.info('详情')
      break
    case '修改':
      window.$message?.info('修改')
      break
    case '删除':
      window.$message?.info('删除')
      break
  }
}

function renderAvatar(row: InternalRowData) {
  return h(NAvatar, { size: 48, src: `${row.avatar}` })
}

function renderStatusTag(row: InternalRowData) {
  const status = row.status
  return h(
    NTag,
    { type: status ? 'success' : 'error' },
    { default: () => (status ? '启用' : '禁用') },
  )
}

async function getTableData() {
  try {
    setLoading(true)
    const { page, pageSize, total, data } = await fetchTableDataPage(
      searchParams.value,
    )
    searchParams.value.page = page!
    searchParams.value.pageSize = pageSize!
    searchParams.value.total = total!
    tableData.value = data
  }
  finally {
    setLoading(false)
  }
}

function handleUpdatePage(page: number) {
  searchParams.value.page = page
  getTableData()
}

function handleUpdatePageSize(size: number) {
  searchParams.value.pageSize = size
  getTableData()
}

function init() {
  getTableData()
}

onMounted(() => init())
</script>

<template>
  <AppTable
    :search-params="searchParams"
    :columns="columns"
    :data="tableData"
    :loading="loading"
    :operations="operations"
    @operate="handleOperate"
    @update:page="handleUpdatePage"
    @update:size="handleUpdatePageSize"
  />
</template>

<style scoped></style>
